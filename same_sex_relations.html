<!DOCTYPE html>
<html lang="en" >

<head>
  <meta charset="UTF-8">
  <title>Is it wrong for same-sex couples to have sexual relations?</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <style>
    div.tooltip {
        position: absolute;
        text-align: center;
        padding: 10px;
        font: 15px sans-serif;
        background: lightsteelblue;
        border: 0px;
        border-radius: 8px;
        pointer-events: none;
        z-index: 999;
        display: none;
    }

    /* svg {
        position: relative;
    } */

    /* div.form-check {
        padding : 1rem;
        margin-left : 20px;
        float: left;
    } */

    /* div.dropdown {
        float: left; */
        /* margin-right: 10px; */
        /* margin: 10px;
        margin-right: 0px;
    } */

    /* div.toolbar {
      position : fixed;
      background-color: rgb(230, 230, 230);
      z-index : 1000;
      top : -1px;
      display: flex;
      justify-content: center;
      top: 30px;
    } */

    /* div.wrapper {
        border: 1px solid black;
    } */
    div.legend {
        border-width: 2px;
        border-style: inset;
        left: 460px;
    }

    /* div.wrapper:last-child {
        left: 0px;
    }*/

    /* html {        
        width: 100%;
        height: 100%;
        margin: 0pt auto;
    } */
    div.body{
        max-width: 720px;
        margin: 0pt auto;
    }

    div.title { 
        z-index : 1000;
        font-size: 25px;
        font-weight: bold;
        font-family: sans-serif;
        display: flex;
        justify-content: center;
        width: 100%;
        /* background-color: rgb(230, 230, 230); */
    }

    div.xaxis{
        /* position: fixed; */
        top: 585px;
        /* background-color: rgb(230, 230, 230); */
        display: flex;
        justify-content: center;
        /* width: 100%; */
        height: 35px;
    }

    @media only screen and (min-width: 1200px) {
        div.legend{
            left: 820px;
        }
        body{
            border: inset;
        }
    }

    div.yaxis{
        /* background-color: rgb(230, 230, 230); */
        display: flex;
        justify-content: center;
        width: 30px;
        height: 100%;
    }

    .tick line{
        display: none;
    }

    circle{
        cursor: pointer;
    }

  </style>
</head>

<body style=" background-color:#e2e2e2; max-width:720px; margin:0pt auto;">
    <!-- <div class='body'> -->
        <div class='title'>Is it wrong for same-sex couples to have sexual relations?</div>
        
        <div class='yaxis' style="font-weight:bold">
            <div style="transform: rotate(-90deg); position:fixed; width:500px; top:120px;">% of Acceptance</div>
        </div>

        <div> 
            <div class='wrapper' style="width:500px; height:270px; top:38px; "><svg id='change' width='500' height='270' stroke-width="3"></svg></div>
            <div class='wrapper' style="width:720px; height:277px; top:308px; "><svg id='line' width='720' height='277' stroke-width="3"></svg></div>
            <div class='legend' style="width:250px; height:200px; top:80px; float:left; position:absolute;">
                <svg width=250 height=200>
                    <rect id='18-34' cursor='pointer' fill='#3c7aff' stroke='#000' x=10 y=10 style="width:20px; height:20px;"></rect>
                    <text id='18-34' cursor='pointer' x=50 y=25>18-34</text>
                    <rect id='35-49' cursor='pointer' fill='#ff5cf1' stroke='#000' x=10 y=40 style="width:20px; height:20px;"></rect>
                    <text id='35-49' cursor='pointer' x=50 y=55>35-49</text>
                    <rect id='50-64' cursor='pointer' fill='#849DB1' stroke='#000' x=10 y=70 style="width:20px; height:20px;"></rect>
                    <text id='50-64' cursor='pointer' x=50 y=85>50-64</text>
                    <rect id='65+' cursor='pointer' fill='#FFAE34' stroke='#000' x=10 y=100 style="width:20px; height:20px;"></rect>
                    <text id='65+' cursor='pointer' x=50 y=115>65+</text>
                    <rect id='end' cursor='pointer' fill='#68f200' stroke='#000' x=10 y=130 style="width:20px; height:20px;"></rect>
                    <text id='end' x=50 y=145 cursor='pointer'>% of Acceptance in 2018</text>
                    <rect id='start' cursor='pointer' fill='#f20000' stroke='#000' x=10 y=160 style="width:20px; height:20px;"></rect>
                    <text id='start' cursor='pointer' x=50 y=175>% of Acceptance in 1973</text>
                </svg>
            </div>
        </div>
        
        <div class='xaxis' style="font-weight:bold;">Year</div>

    <!-- </div> -->
    


  <!-- <div class='filters'>
    <text>Age Group</text>
    <select class="option" id="age_group"></select>
    <text>Sex</text>
    <select class="option" id="sex"></select>
    <text>Day Type</text>
    <select class="option" id="day_type"></select>
    <input type="checkbox" id="show_error"> Show Standard Error
  </div> -->

  
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
  
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script>
    var changeSvg = d3.select('svg#change')
    var lineSvg = d3.select('svg#line')

    var csvData = [];
    var ageGroup = [];

    var lineWidth = 700;
    var lineHeight = 277;
    var changeWidth = 500;
    var changeHeight = 270;
    var lineMin = 0;
    var lineMax = 0;

    var yearList = [];
    var ageGroupColor = {'18-34':'#3c7aff','35-49':'#ff5cf1','50-64':'#849DB1','65+':'#FFAE34'}

    var parseTime = d3.timeParse("%Y");

    // Adding Tooltip in body
    var div = d3.select("body").append("div").attr("class", "tooltip").style("opacity", 1);
    body_sel = d3.select('body');
    body = { w: body_sel.node().offsetWidth, h: body_sel.node().offsetHeight };

    // d3.csv('./same_sex_relations.csv').then(function(data, error) {
    d3.csv('http://blog.dteam.in/wp-content/uploads/2019/06/same_sex_relations.csv').then(function(data, error) {
        data.forEach(function(d){
            tmp = {'values':[]};
            currentVal = 0;
            Object.keys(d).forEach(function(e){
                if ((!ageGroup.includes(d[e])) && (e == 'Age')){
                    ageGroup.push(d[e]);
                    tmp['age'] = d[e];
                }
                else {
                    tmp['values'].push({'year':e,'response':d[e]})
                    currentVal = d[e];
                }
                if ((!yearList.includes(e)) && (e != 'Age')){
                    yearList.push(e)
                }
                if (+d[e] < lineMin) {
                    lineMin = +d[e];
                }
                if (+d[e] > lineMax) {
                    lineMax = +d[e];
                }
            })
            tmp['currentVal'] = currentVal;
            csvData.push(tmp);
        })


        lineYearAxis = d3.scaleTime().range([0, lineWidth-120]).domain(d3.extent(yearList, function(d) { return parseTime(d); }));
        lineResponseAxis = d3.scaleLinear().range([0,lineHeight-50]).domain([100,0]).nice();
        lineXAxis = d3.axisBottom().scale(lineYearAxis).ticks(10).tickSize(10).tickFormat(d3.timeFormat('%Y'));
        lineYAxis = d3.axisLeft().scale(lineResponseAxis).ticks(5).tickSize(10);
        lineYAxisG = lineSvg.append('g').attr('class','yaxis').attr("transform", "translate(70,20)").call(lineYAxis);
        lineXAxisG = lineSvg.append('g').attr('class','xaxis').attr("transform", "translate(70," + (lineHeight-30) + ")").call(lineXAxis);
        
        changeAgeAxis = d3.scaleBand().range([0, changeWidth-120]).domain(ageGroup);
        changeResponseAxis = d3.scaleLinear().range([0,changeHeight-50]).domain([100,0]).nice();
        changeXAxis = d3.axisBottom().scale(changeAgeAxis);
        changeYAxis = d3.axisLeft().scale(changeResponseAxis).ticks(5).tickSize(10);
        changeYAxisG = changeSvg.append('g').attr('class','yaxis').attr("transform", "translate(70,20)").call(changeYAxis);
        changeXAxisG = changeSvg.append('g').attr('class','xaxis').attr("transform", "translate(70," + (changeHeight-30) + ")").call(changeXAxis);

        // define the line
        var line = d3.line().x(function(d) { return lineYearAxis(parseTime(d.year)); }).y(function(d) { return lineResponseAxis(+d.response); });

        var lineAgeG = lineSvg.selectAll('g.line').data(csvData).enter().append('g').attr('class',function(d){ return d['age'];}).attr('id',function(d){ return 'age_'+d['age'].replace(/[^a-zA-Z0-9_]/g,'_');}).attr('transform','translate(72,20)');
        
        lineAgeG.selectAll('path.line').data(d=>[d]).enter().append("path")
                .attr("class", "line")
                .attr('fill','none')
                .attr("stroke", function(d) { return ageGroupColor[d['age']]; })
                .attr('stroke-width',4)
                .datum(d => d.values)
                .attr("d", line)
                
        lineAgeG.selectAll('circle').data(d=>d.values).enter().append("circle").attr('class','points')
                .attr('r',4)
                .attr('cx',function(d) { return lineYearAxis(parseTime(d.year)); })
                .attr('cy',function(d) { return lineResponseAxis(+d.response); })
                .attr('fill','#555')
                .attr('opacity','0')
                
        lineAgeG.selectAll('text').data(d=>[d]).enter().append('text').attr('class','line')
            .html(d => d.age)
            .attr('fill', d => ageGroupColor[d['age']])
            .attr('alignment-baseline', 'middle')
            .attr('x', lineWidth-120)
            .attr('dx', '.5em')
            .attr('font-size',14)
            .attr('font-weight','bolder')
            .attr('y', d => lineResponseAxis(d.currentVal)); 
        
        var changeStartG = changeSvg.selectAll('g.circle').data(csvData).enter().append('g').attr('class',function(d){ return d['age'];}).attr('id',function(d){ return 'age_'+d['age'].replace(/[^a-zA-Z0-9_]/g,'_');}).attr('transform','translate(120,20)')

        changeStartG.selectAll('line.change').data(d => [d]).enter().append('line')
                .attr('class','change')
                // .attr('stroke',function(d) { return ageGroupColor[d['age']]; })
                .attr('stroke','#bbb')
                .attr('x1',function(d){ return changeAgeAxis(d['age']);})
                .attr('x2',function(d){ return changeAgeAxis(d['age']);})
                .datum(function(d) { return arrayFilter(d.values);})
                .attr('y1',function(d){ return changeResponseAxis(+d['start']);})
                .attr('y2',function(d){ return changeResponseAxis(+d['end']);})

        changeStartG.selectAll('circle.start').data(d => [d]).enter().append('circle')
                .attr('class','start')
                .attr('r',10)
                .attr('fill','#f20000')
                .attr('cx',function(d){ return changeAgeAxis(d['age']);})
                .datum(d => d.values[0])
                .attr('cy',function(d){ return changeResponseAxis(+d['response']);})
                
        changeStartG.selectAll('circle.end').data(d => [d]).enter().append('circle')
                .attr('class','end')
                .attr('r',10)
                .attr('fill','#68f200')
                .attr('cx',function(d){ return changeAgeAxis(d['age']);})
                .datum(d => d.values[yearList.length-1])
                .attr('cy',function(d){ return changeResponseAxis(+d['response']);})

        d3.selectAll('circle').on('mouseover',function(d){
                            d3.select(this).attr('opacity','1')
                            div.transition().duration(100).style('display','inline')
                        })
                        .on('mouseout',function(d){
                            d3.select(this).attr('opacity','0')
                            div.transition().duration(100).style('display','none')
                        })
                        .on('mousemove',function(d){
                            if (d3.event.pageX < (body.w-200)){
                                div.style('left',(d3.event.pageX + 20) + "px")
                            }
                            else {
                                div.style('left',(d3.event.pageX - 200) + "px")
                            }
                            if (d3.event.pageY <= 520){
                                div.style('top',(d3.event.pageY + 20) + "px")
                            }
                            if (d3.event.pageY > 520) {
                                div.style('top',(d3.event.pageY - 100) + "px")
                            }
                            msg = '<b> Age: </b> ' + d3.event['target']['parentElement']['classList'][0] + '</br> <b> Year: </b>' + d['year'] + '</br> <b> % of Acceptance: </b>' + d['response'] +'%';
                            div.html(msg);
                        });
        
        d3.selectAll('rect, text').on('mouseover',function(d){
                                d3.selectAll('circle.start').style('opacity',0.1)
                                d3.selectAll('circle.end').style('opacity',0.1)
                                d3.selectAll('line.change').style('opacity',0.1)
                                d3.selectAll('path.line').style('opacity',0.1)
                                d3.selectAll('text.line').style('opacity',0.1)
                                changeSvg.selectAll('g#age_'+ d3.event['target']['id'].replace(/[^a-zA-Z0-9_]/g,'_') + ' circle').style('opacity',1)
                                changeSvg.selectAll('g#age_'+ d3.event['target']['id'].replace(/[^a-zA-Z0-9_]/g,'_') + ' line').style('opacity',1)
                                lineSvg.selectAll('g#age_'+ d3.event['target']['id'].replace(/[^a-zA-Z0-9_]/g,'_') + ' path.line').style('opacity',1)
                                lineSvg.selectAll('g#age_'+ d3.event['target']['id'].replace(/[^a-zA-Z0-9_]/g,'_') + ' text.line').style('opacity',1)
                            })
                            .on('mouseout',function(d){
                                d3.selectAll('circle.start').style('opacity',1)
                                d3.selectAll('circle.end').style('opacity',1)
                                d3.selectAll('line.change').style('opacity',1)
                                d3.selectAll('path.line').style('opacity',1)
                                d3.selectAll('text.line').style('opacity',1)
                            })

        d3.selectAll('rect#start, text#start').on('mouseover',function(d){
                                d3.selectAll('circle.end').style('opacity',0.1)
                                d3.selectAll('line.change').style('opacity',0.1)
                                changeSvg.selectAll('g#age_'+ d3.event['target']['id'].replace(/[^a-zA-Z0-9_]/g,'_') + ' circle').style('opacity',1)
                                changeSvg.selectAll('g#age_'+ d3.event['target']['id'].replace(/[^a-zA-Z0-9_]/g,'_') + ' line').style('opacity',1)
                            })
                            .on('mouseout',function(d){
                                d3.selectAll('circle.end').style('opacity',1)
                                d3.selectAll('line.change').style('opacity',1)
                            })
        d3.selectAll('rect#end, text#end').on('mouseover',function(d){
                                d3.selectAll('circle.start').style('opacity',0.1)
                                d3.selectAll('line.change').style('opacity',0.1)
                                changeSvg.selectAll('g#age_'+ d3.event['target']['id'].replace(/[^a-zA-Z0-9_]/g,'_') + ' circle').style('opacity',1)
                                changeSvg.selectAll('g#age_'+ d3.event['target']['id'].replace(/[^a-zA-Z0-9_]/g,'_') + ' line').style('opacity',1)
                            })
                            .on('mouseout',function(d){
                                d3.selectAll('circle.start').style('opacity',1)
                                d3.selectAll('line.change').style('opacity',1)
                            })
    })

    function arrayFilter(array){
        tmp = {'start':0,'end':0}
        for (i=0; i < array.length; i++){
            if (array[i]['year'] == '1973'){
                tmp['start'] = array[i]['response']
            }
            if (array[i]['year'] == '2018'){
                tmp['end'] = array[i]['response']
            }
        }
        return tmp;
    }

  </script>
</body>

</html>
